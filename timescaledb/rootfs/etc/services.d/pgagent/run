#!/usr/bin/with-contenv bashio
# ==============================================================================
# Start PgAgent service if enabled
# ==============================================================================

# Wait for postgres to become available..
while ! psql -U "postgres" postgres -c "" 2> /dev/null; do
	sleep 1
done


bashio::log.info "Enabling PgAgent Extension.."
psql -U "postgres" -d "postgres" -c "CREATE EXTENSION IF NOT EXISTS pgagent;" || true >> /var/log/pgagent.run.log
psql -U "postgres" -d "postgres" -X -c "ALTER EXTENSION pgagent UPDATE;" || true >> /var/log/pgagent.run.log

# And run the daemon in the foreground
bashio::log.info "Starting PgAgent.."
/usr/local/bin/pgagent hostaddr=127.0.0.1 dbname=postgres user=postgres -f
